参看 https://mp.weixin.qq.com/s/FSyE7Tz5A-Rc1bkC-tDqvA

https://www.cnblogs.com/0201zcr/p/5296843.html

# B树

## 1、特征

```
一个m阶B树具以下特征：

1.根结点至少有两个子女。

2.每个中间节点都包含k-1个元素和k个孩子，其中 m/2 <= k <= m

3.每一个叶子节点都包含k-1个元素，其中 m/2 <= k <= m

4.所有的叶子结点都位于同一层。

5.每个节点中的元素从小到大排列，节点当中k-1个元素正好是k个孩子包含的元素的值域分划。

```

## 2、简介

```
一个m阶的B+树具有如下几个特征：

B树是多路平衡树，它的每个节点最多k个孩子，k称为B树的阶。

B树的思想是，普通的平衡二叉树高度还是比较高的，最坏情况IO访问树=树的高度。所以，为了降低树的高度。

删除、新增节点可能出现 左旋、右旋，即父节点的值交换到（左、右）子节点。
```



# B+树

## 1、特征

```
1.有k个子树的中间节点包含有k个元素（B树中是k-1个元素），每个元素不保存数据，只用来索引，所有数据都保存在叶子节点。

2.所有的叶子结点中包含了全部元素的信息，及指向含这些元素记录的指针，且叶子结点本身依关键字的大小自小而大顺序链接。

3.所有的中间节点元素都同时存在于子节点，在子节点元素中是最大（或最小）元素。

					    8		   		15
					  /					\
			2	 5 		8				11 			15	
		/		/		\				/			\
	1  2  --→ 3 5	--→  6 8	--→		9 11	--→	13	15
	

```

## 2、注意

```
父节点的元素是子节点元素最大（最小）值 。

只有叶子节点保存数据，其他都是保存索引。目的是将数据统一放在比较集中的内存页中，减少IO。

只有叶子节点保存全部数据，叶子节点形成有序链表。

“卫星数据”是B+树最具特点的特点。
```

**在数据库的聚集索引（Clustered Index）中，叶子节点直接包含卫星数据。在非聚集索引（NonClustered Index）中，叶子节点带有指向卫星数据的指针。**

上面的理解：聚集索引是指索引顺序等同于物理内存中真实数据的存储顺序。很好理解，B树中相同大小的数据在同一节点中，更小的在其子节点。依次递减 ； 而B+树中，仅叶子节点存储数据，最后形成有序链表，可观察看到，实际中已经没有什么大小、先后顺序，而是按照最终的结果连接下去。可直接在有序链表访问下一个，适合范围查找。

简单理解：B+树前后数据不相邻，散乱的，如同非聚集索引，真实数据与索引是没有位置上的对应关系。而B树的如同聚集索引，有位置上的对应关系。





# Mysql底层基础知识



## 1、数据存于 内存页 中



![img](https://mmbiz.qpic.cn/mmbiz_jpg/UtWdDgynLdYJzfyu1L8rI8asia8NkuKt5T48YfPCvlJ5ezEXwiceNJy5M6Tnm92iabODzBchAiaBB53DHZC4jeuMHg/640?tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![img](https://mmbiz.qpic.cn/mmbiz_png/UtWdDgynLdYJzfyu1L8rI8asia8NkuKt5EzRxwHBoOMouEyU6amCQjGAWfCpU95TlRc6fr95symcMDicLNpBic8yA/640?tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



- 各个数据页可以组成一个双向链表；**页间双向链表**

- 而每个数据页中的记录又可以组成一个单向链表；**页中记录单向链表**

- 每个数据页都会为存储在它里边儿的记录生成一个页目录，在通过主键查找某条记录的时候可以在页目录中使用二分法快速定位到对应的槽，然后再遍历该槽对应分组中的记录即可快速找到指定的记录；**主键查找可用二分法快速在页中定位**

- 以其他列(非主键)作为搜索条件：只能从最小记录开始依次遍历单链表中的每条记录。

  **非主键查找只能在页间从小逐条查找**

  

## 2、索引提升检索速度

​	索引之所提升速度，是将 无序的数据 变 相对。因为索引可以将一个范围内的数据存在一个内存页，而非随意存储任意范围的数据。并且即使一个内存页没有该数据，也记录了再哪个内存页可能搜到，不必一个个内存页去遍历。![img](https://mmbiz.qpic.cn/mmbiz_png/UtWdDgynLdYJzfyu1L8rI8asia8NkuKt5tqrOPoaicQM2NnZSia0k6iaurQVsiaGicF2OUTFtWCvC9gx5uicZzPsuxMDw/640?tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)有序。





## 3、 索引为什么降低 增删改的数据

​	索引可以通过B+树创建，B+树不会在极端的情况变成瘦高的树（父节点也将变成子节点的一个元素）他会维持自平衡，数据在树结构以节点形式存在。对数据的增删改可能导致树的自平衡过程，即重构过程，势必降低一些性能。



## 4、哈希索引

### 优点

* 采用一定的hash算法，将key映射为hash值，直接查找，速度快，但是也有缺点

### 缺点

* 哈希索引也没办法利用索引完成排序；
* 不支持最左匹配原则；
* 在有大量重复键值情况下，哈希索引的效率也是极低的---->哈希碰撞问题；
* 不支持范围查询；



## 5、InnoDB 支持

* B+树索引较多，对于哈希索引，InnoDB是自适应哈希索引的（hash索引的创建由InnoDB存储引擎引擎自动优化创建，我们干预不了）！



##6、聚集索引和非聚集索引



###简单概括：

- 聚集索引就是以主键创建的索引；
- 非聚集索引就是以非主键创建的索引；

###区别：

- 聚集索引在叶子节点存储的是表中的数据；
- 非聚集索引在叶子节点存储的是主键和索引列；
- 使用非聚集索引查询出数据时，拿到叶子上的主键再去查到想要查找的数据。(拿到主键再查找这个过程叫做**回表**)



## 7、索引最左匹配原则

- 索引可以简单如一个列(a)，也可以复杂如多个列(a, b, c, d)，即联合索引。
- 如果是联合索引，那么key也由多个列组成，同时，索引只能用于查找key是否存在（相等），遇到范围查询(>、<、between、like左匹配)等就不能进一步匹配了，后续退化为线性查找。
- 因此，列的排列顺序决定了可命中索引的列数。

不需要考虑=、in等的顺序，mysql会自动优化这些条件的顺序，以匹配尽可能多的索引列。

例子：

- 如有索引(a, b, c, d)，查询条件c > 3 and b = 2 and a = 1 and d < 4与a = 1 and c > 3 and b = 2 and d < 4等顺序都是可以的，MySQL会自动优化为a = 1 and b = 2 and c > 3 and d < 4，依次命中a、b、c。



## 8、索引总结

1，最左前缀匹配原则。MySQL会一直向右匹配直到遇到范围查询（>,<,BETWEEN,LIKE）就停止匹配。

2、尽量选择值不重复的列，减少出现相同值碰撞的情况。（变成逐页扫描了）

3、索引列不能参与计算，因为这样B+树的节点存着是数据表中的字段值，但是进行检索时，需要把所有元素都进行计算才能比较，代价太大。

4、 尽量扩展索引，不要新建索引。如已经有a的索引，现加（a,b）的索引，则只需修改原来的索引。

5、单个多列组合索引和多个单列组合索引查询结果不同，在执行SQL时，Mysql只能使用一个索引。会从多个单列索引中选一个最细致的索引。





# 索引

https://mp.weixin.qq.com/s/VFBIT4J_ATSdTguFXXhvzg

主键索引时，叶子节点存储的即是主键的值；而普通列索引时，叶子节点存的是对应主键的值，然后根据其去搜索对应的值。且主键是二分查找，速度快，非主键是逐行查找。

## 1、数据定位过程

以mysql的B+树为例：

第一种场景：索引精确查找

第二种场景：索引范围查找

第三种场景：全表扫描（找非主键且无索引的）

第四中场景：二级索引查找

## 2、索引的类别

###聚簇索引与非聚簇索引

简单来说，聚集索引是一种索引组织形式，索引的键值逻辑顺序决定了表数据行的物理存储顺序，而非聚集索引则就是普通索引了，仅仅只是对数据列创建相应的索引，不影响整个表的物理存储顺序。

聚簇索引的优点有：

- 范围查询效率更高；
- 特别适合有一小部分热点数据频繁读写的场景；
- 通过主键访问数据时快速可达；

InnoDB引擎是聚集索引组织表，它的聚集索引选择规则是这样的：

- 首先选择显式定义的主键索引做为聚集索引；
- 如果没有，则选择第一个不允许NULL的唯一索引；
- 还是没有的话，就采用InnoDB引擎内置的ROWID作为聚集索引；





### 主键索引和辅助索引

主键索引，简称主键，由一个或多个列组成，用于唯一性标识数据表中的某一条记录。

InnoDB数据表的主键设计通常遵循几个原则：

- 采用一个没有业务用途的自增属性列作为主键；

- 主键字段值总是不更新，只有新增或者删除两种操作；

- 不选择会动态更新的类型，比如当前时间戳等；

  

辅助索引，常规所指的索引，也叫二级索引，又分为唯一索引和非唯一索引。

InnoDB引擎中，主键索引会被选中作为聚集索引，而唯一索引和普通辅助索引间除了唯一性约束外，在存储上没本质区别。



###MyISAM 和 InnoDB

MyISAM 索引使用B+树实现，叶子节点存的都是真实数据的实际地址，所以对主键没有强制要求，实现方式是“非聚集”的，因为真实数据的位置相对任意。



InnoDB索引也是B+树实现，但是叶子节点存的是主键key的值，所以InnoDB强制要求要有主键，并且最好主键是单调连续的，否则插入删除数据开销大（对B+树的自平衡）