# 限流

​	限流，一个接口的承受能力是有限的，如果某一时间突然来了大流量的请求冲击一个接口，可能导致服务超时奔溃。缓存可以阻挡一定流量，缓存存在三个问题，在另外的文档可看。除了缓存，也可以通过限制单位时间访问某一接口的流量来保护接口。限流有四种算法



## 一、限流算法

https://mp.weixin.qq.com/s/8xN3gaRDUVDzjvNPboTeqA

### 1、计数器法

​	最简单直观，假设在一个时间段，这里设 1min允许访问个数为1000个请求，每当来一个请求：判断是否超过上一个1min，是，则重置 这1min，然后请求个数+1 ；如果没有超过，则直接请求个数+1。当达到1000个时，时间还未过，拒绝新来的请求。

​	存在问题：单位时间的边界问题。即上一1min的最后一秒来了1000个请求，过了1秒新的1min，又来1000个请求，即共2000个请求都在2s内发过来，超过处理能力。



### 2、滑动窗口

​	思想: 可以看过是一段时间段分为多个计数器。将一个 1min分为多个段，这里假设分为6个段，每个段占10s 。每过10s，滑块就往右滑一个口，总共的处理能力，就是每个段处理的请求的和。这样，即便是压着线发来的请求，也会因为原先的限制还在，导致请求失败。即相比计数器法，滑块窗口的限制是一部分一部分抛弃，而不是一次性全部清空 。

​	存在的问题，比较麻烦，段间同步之类的实现，以及不够平滑，一个段一个段释放。

​	

### 3、漏桶算法

​	思想：像有漏洞的水桶一样，水往通里倒，桶中水从孔中流出来。流水就是一个个请求，请求先到桶中，然后部分请求就从桶的孔中流出被处理。当流入桶中的水要溢出时（超过限制），就不允许请求进入了。

​	桶就相当于一个缓冲区，服务器取漏孔中的请求处理。桶满拒绝请求，桶没满就允许新请求入桶，并取桶中请求处理。



### 4、令牌桶算法

​	思想，这次也是桶，桶中放令牌，来个请求，可以取走令牌，允许一次取1、2、3 .. N个令牌，取到令牌才可以被响应。没有取到令牌的，被拒绝或阻塞。这个算法允许一定的流量爆发。



### 比较

**计数器和滑动窗口比较**

计数器算法实现起来最简单，可以看成是滑动窗口的低精度实现。滑动窗口由于需要存储多份的计数器（每一个格子存一份），所以滑动窗口在实现上需要更多的存储空间。也就是说，如果滑动窗口的精度越高，需要的存储空间就越大。

**漏桶算法和令牌桶算法比较**

|              | 漏桶算法                                                     | 令牌桶算法                                                   |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 请求何时拒绝 | 流入请求速率任意，常量固定速率流出请求。当流入请求数积累到漏桶容量时，则拒绝新请求 | 固定速率往桶中添加令牌，如果桶中令牌不够，则拒绝新请求       |
| 速率限制     | 限制常量流出速率（流出速率是固定值），从而 **平滑突发流入速率** | 限制平均流入速率，**允许一定程度的突发请求**（支持一次拿多个令牌） |