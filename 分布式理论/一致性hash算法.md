https://blog.csdn.net/bntX2jSQfEHy7/article/details/79549368

# 场景引入

## 一、Redis集群使用

​	加入图片路径放在redis集群中，若不知道某一图片放在哪个redis中，则需要遍历。开销大。那么分库的规则就出来了，如hash值、取模、按照类分、按照某字段的值。

### 1、按hash分

​	可以计算图片hash值再对集群数量取模，得到对应的redis。 hash(url ) % number 

存在问题：

  - 如果增加、减少集群中服务器的数量，那么所有存储的路径都需要改，因为number变了
  - 换句话说，当服务器数量发生改变时，所有缓存在一定时间内是失效的，当应用无法从缓存中获取数据时，则会向后端数据库请求数据（**缓存雪崩**）



## 二、一致性hash算法诞生

​	为了解决hash算法本身取模带来的局限性。

​	思想：

​		不再对服务器数量取模，而是 用服务器的标识（如 ip \ 主机名 之类）, 对 2的32次方-1 进行hash计算。得到的值就是  0 → 2的32次方-1 形成的环上的一个位置。这个环就是 hash范围。当要查询一个key时，通过相同的hash算法，得到在环上的一个位置后，顺时针行走，碰到的第一个服务器就是其所在的缓存服务器。 这么做的好处是，即使某台宕机或者新增某台服务器，受影响的只是一段范围内的缓存数据。



​	存在问题: 数据倾斜

​		如果仅有少数几台缓存服务器，那么存在这么个问题，比如两台，位置还很相近，那么久可能一台服务器承受很多缓存数据而另外一台，仅承受小部分查询缓存。

​	解决：虚拟节点机制

​		所谓虚拟节点，就是通过有限的服务器构建出来的。比如现在仅两台缓存服务器。分为A，B，可以根据其ip后面再添序号，如： A1、A2 、 A3```， B也是，然后分别hash，得到在hash环上的位置，这样相当于有很多台虚拟机在环上。而后，再次计算key的hash值，得到在某个范围如： A2→B1,那么属于B； B3→ A3,那么属于A。可以解决。一般分出32个以上的虚节点。