

https://mp.weixin.qq.com/s/kHpk1mCYOOPSD609fm7lIA

https://www.cnblogs.com/danbing/p/7459224.html （推荐）

# 负载均衡

​	通常，单机服务在流量大的时候，一台服务器不够支持，我们可能会考虑分布到多太，形成集群，那么为了合理将流量根据实际网路、负载情况分到服务器，我们就需要负载均衡。

​	

## 一、 负载均衡策略

### 1、轮询（静态）

​	平均分配，一人一个，最简单，但是不能考虑到机器间不同的处理能力已经网络延迟的问题。

### 2、加权轮询（动态）

​	在轮询基础上增加一个权重，这个权重可以是机器的处理能力、网络延迟的大小等，能者多劳的意思。

​	权重应该是不断变化的，否则可能出现持续的请求导致超载。

### 3、最少连接数（动态）

​	根据实时情况，一般将请求发到最少处理请求的服务器上。

### 4、最快响应（动态）

​	动态记录每台服务器的平均响应时间，时间越短代表越通畅，就可以将优先考虑处理请求。

### 5、hash法（静态）

​	与前面4中不同，hash法是发生在客户端的，在客户端通过散列函数均匀散列在不同服务器上，并去访问。

​	这个方法就有一定问题了，虽然也是简单直观，但是变成了划分区域固定访问，并且增删服务器可能导致大的变化

​	（有的散列规则和服务器数目有关，某台服务器挂掉，可能导致一部分请求不知道去哪里找，所以衍生了**一致性**

​	**hash算法**）。

### 6、IP、URL散列（静态）

​	拿ip\url来进行散列，达到一类分组、一类服务到某台机器。



借图：

![img](https://mmbiz.qpic.cn/mmbiz_png/MOwlO0INfQq7qNuAv0vwkh4vaL36TLIdBPz5eqbJKibNrHws3wcd4FWVD1QJu1G1FHv6wiacAwqfHnc554e0XeCw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)





## 二、健康探测

​	借用负载均衡，我们可以保证集群高效高可用，负载均衡需要知道集群中哪台机器已经不能提供服务进行剔除。那么确保一个服务是否可用就有几个健康探测策略。

### 1、HTTP探测

​	定期通过发送一个http请求，通过得到的response分析其状态码、响应内容判断是否可用，这是应用层方面的。

### 2、TCP探测

​	基于TCP三次握手，进行三次握手阶段，如果握手成功代表负载均衡服务器正常，就需要立刻发送一个请求来中断连接。因为这个握手的意义只是检测，不传输数据。	



### 3、UDP探测

​	检测中心定期向服务器发送一个UDP探测包，如果没有收到响应，默认服务器是正常的。如果服务器不正常，就会返回一个ICMP包，说明服务器出现的错误。

​	ICMP（Internet Control Message Protocol）Internet控制报文协议。它是TCP/IP协议簇的一个子协议，用于在IP主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。 









