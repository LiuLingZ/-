

https://mp.weixin.qq.com/s/kHpk1mCYOOPSD609fm7lIA

https://www.cnblogs.com/danbing/p/7459224.html （推荐）

https://www.jianshu.com/p/fa937b8e6712

# 负载均衡

​	通常，单机服务在流量大的时候，一台服务器不够支持，我们可能会考虑分布到多太，形成集群，那么为了合理将流量根据实际网路、负载情况分到服务器，我们就需要负载均衡。

​	

## 一、 负载均衡策略

### 1、轮询（静态）

​	平均分配，一人一个，最简单，但是不能考虑到机器间不同的处理能力已经网络延迟的问题。

### 2、加权轮询（动态）

​	在轮询基础上增加一个权重，这个权重可以是机器的处理能力、网络延迟的大小等，能者多劳的意思。

​	权重应该是不断变化的，否则可能出现持续的请求导致超载。

### 3、最少连接数（动态）

​	根据实时情况，一般将请求发到最少处理请求的服务器上。

### 4、最快响应（动态）

​	动态记录每台服务器的平均响应时间，时间越短代表越通畅，就可以将优先考虑处理请求。

### 5、hash法（静态）

​	与前面4中不同，hash法是发生在客户端的，在客户端通过散列函数均匀散列在不同服务器上，并去访问。

​	这个方法就有一定问题了，虽然也是简单直观，但是变成了划分区域固定访问，并且增删服务器可能导致大的变化

​	（有的散列规则和服务器数目有关，某台服务器挂掉，可能导致一部分请求不知道去哪里找，所以衍生了**一致性**

​	**hash算法**）。

### 6、IP、URL散列（静态）

​	拿ip\url来进行散列，达到一类分组、一类服务到某台机器。



借图：

![img](https://mmbiz.qpic.cn/mmbiz_png/MOwlO0INfQq7qNuAv0vwkh4vaL36TLIdBPz5eqbJKibNrHws3wcd4FWVD1QJu1G1FHv6wiacAwqfHnc554e0XeCw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)





## 二、健康探测

​	借用负载均衡，我们可以保证集群高效高可用，负载均衡需要知道集群中哪台机器已经不能提供服务进行剔除。那么确保一个服务是否可用就有几个健康探测策略。

### 1、HTTP探测

​	定期通过发送一个http请求，通过得到的response分析其状态码、响应内容判断是否可用，这是应用层方面的。

### 2、TCP探测

​	基于TCP三次握手，进行三次握手阶段，如果握手成功代表负载均衡服务器正常，就需要立刻发送一个请求来中断连接。因为这个握手的意义只是检测，不传输数据。	



### 3、UDP探测

​	检测中心定期向服务器发送一个UDP探测包，如果没有收到响应，默认服务器是正常的。如果服务器不正常，就会返回一个ICMP包，说明服务器出现的错误。

​	ICMP（Internet Control Message Protocol）Internet控制报文协议。它是TCP/IP协议簇的一个子协议，用于在IP主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。 



## 三、四层、七层负载均衡

### 1、核心区别：

​	四层是转发客户端请求，让客户端直接访问服务器，与服务器直接交互。

​	七层是“代理”作用，客户端与负载均衡服务器建立TCP连接，然后接收其请求，负载均衡服务器再选择一台服务器简历TCP连接，将请求内容取出，再发一个请求包给服务器，得到相应后，再把响应返回给客户端。			

​	所谓四层，指的是OSI七层中的第四层：传输层，通过报文中目标地址和端口，根据自己的负载均衡策略选择服务器转发。

​	所谓七层，需要用到OSI七层中第七层：应用层，因为负载均衡服务器接收客户端请求会在应用层层面解析，再根据制定的策略与服务器进行TCP连接，再发送请求。





### 2、各自优缺点

​	四层看起来安全性其实不高，只是起到一个转发作用，什么请求都转发，并且灵活性低。不过简单明了。	

​	七层看起来好像安全性，这里的安全性比如，有人控制很多肉鸡同时发请求攻击服务，造成服务 Denial of Service*(*DoS) ，而七层负载均衡可以在负载均衡阶段就将请求过滤、丢弃之类的，保证服务的安全。但是负载均衡本身也要有很强的抗DoS的能力，不然崩了系统照样崩了。

​	灵活性，七层可以提前拆包看请求，所以可以根据需要制定对应的负载策略，什么请求给什么服务器。如文本请求给文本服务器，图片请求给图片服务器之类。

​	但是，七层代表着额外的硬件设备和设计、应用的复杂性，需要权衡。



## 四、 负载均衡的实现

### 1、DNS域名解析负载均衡

​	在DNS服务器进行负载均衡，因为一个域名可以对应多个IP，但是DNS负载均衡就不受网站控制了，而且存在DNS的缓存和本地服务器缓存不一致问题，服务器已经更换或者卸载，DNS可能更新了但是本地还在缓存，或者DNS还缓存，导致有一段时间访问不到。



### 2、数据链路层负载均衡（LVS）

　	这种数据传输方式又称作三角传输模式，负载均衡数据分发过程中不修改IP地址，**只修改目的的mac地址**，通过配置真实物理服务器集群所有机器虚拟IP和负载均衡服务器IP地址一样，从而达到负载均衡，这种负载均衡方式又称为直接路由方式（DR）。

​	**同机房，只改mac地址**

![æ°æ®é¾è·¯å±è´è½½åè¡¡(LVS)](https://upload-images.jianshu.io/upload_images/1935978-46ee563e9884a0d8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



### 3、IP负载均衡（SNAT）

​	SNAT：源地址转换。这里的关键在于真实WEB服务器相应数据包如何返回给负载均衡服务器，一种是负载均衡服务器在修改目的IP地址的同时修改源地址，将数据包源地址改为自身的IP，即源地址转换（SNAT），另一种方案是将负载均衡服务器同时作为真实物理服务器的网关服务器，这样所有的数据都会到达负载均衡服务器。（**以同机房的负载均衡服务器作为中介与外界交换数据，负载均衡服务器作为网关或者配置多个网卡，可能成为瓶颈**）

![IPè´è½½åè¡¡](https://upload-images.jianshu.io/upload_images/1935978-837df95b32cbcb4f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)





### 4、反向代理负载均衡(nginx)

​	相比IP负载均衡，负载均衡服务器不在同机房，而是作为一台单独的服务器，作为代理用。

![ååä"£çè´è½½åè¡¡](https://upload-images.jianshu.io/upload_images/1935978-0a9ac869855567c8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



### 5、HTTP负载均衡

​	先发请求到负载均衡服务器，服务器返回新的地址，让客户端重定向。问题是可能让搜索引擎以为是作弊，然后就降低搜索排名。因为你302重定向，就像是小广告跳转。

![HTTPéå®åè´è½½åè¡¡](https://upload-images.jianshu.io/upload_images/1935978-001193a4992fdffa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)