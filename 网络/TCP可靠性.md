

# TCP可靠性

​	TCP可靠性主要依赖下面7种机制。

https://blog.csdn.net/xuzhangze/article/details/80490362

​	

## 1、检验和 

TCP检验和的计算与UDP一样，在计算时要加上12byte的伪首部，检验范围包括TCP首部及数据部分，但是UDP的检验和字段为可选的，而TCP中是必须有的。计算方法为：在发送方将整个报文段分为多个16位的段，然后将所有段进行反码相加，将结果存放在检验和字段中，接收方用相同的方法进行计算（将接受的报文同样分段反码相加，得到接受的检验和），如最终结果为检验字段（放在头部的旧校验和+新得到的校验和相加）所有位是全1则正确（UDP中为0是正确），否则存在错误。 



## 2、序列号 

TCP将每个字节的数据都进行了编号，这就是序列号。 
序列号的作用： 
a、保证可靠性（当接收到的数据总少了某个序号的数据时，能马上知道） 
b、保证数据的按序到达 
c、提高效率，可实现多次发送，一次确认 
d、去除重复数据 

**数据传输过程中的确认应答处理、重发控制以及重复控制等功能都可以通过序列号来实现。** 

## 

## 3、确认应答机制（ACK） 

TCP通过确认应答机制实现可靠的数据传输。**在TCP的首部中有一个标志位——ACK，此标志位表示确认号是否有效。**接收方对于按序到达的数据会进行确认，当标志位ACK=1时确认首部的确认字段有效。进行确认时，确认字段值表示这个值之前的数据都已经按序到达了。而发送方如果收到了已发送的数据的确认报文，则继续传输下一部分数据；而如果等待了一定时间还没有收到确认报文就会启动重传机制。 



## 4、超时重传机制 

当报文发出后在一定的时间内未收到接收方的确认，发送方就会进行重传（通常是在发出报文段后设定一个闹钟，到点了还没有收到应答则进行重传）。当然，未收到确认不一定就是发送的数据包丢了，还可能是确认的ACK丢了。

![img](https://img-blog.csdn.net/20180528233101484?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h1emhhbmd6ZQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)





## 5、连接管理机制 

​	连接管理机制即TCP建立连接时的三次握手和断开连接时的四次挥手。 





## 6、流量控制 

接收端处理数据的速度是有限的，如果发送方发送数据的速度过快，导致接收端的缓冲区满，而发送方继续发送，就会造成丢包，继而引起丢包重传等一系列连锁反应。 
因此TCP支持根据接收端的处理能力，来决定发送端的发送速度，这个机制叫做流量控制。 

在TCP报文段首部中有一个16位窗口长度，当接收端接收到发送方的数据后，在应答报文ACK中就将自身缓冲区的剩余大小，放入16窗口大小中。这个大小随数据传输情况而变，窗口越大，网络吞吐量越高，而一旦接收方发现自身的缓冲区快满了，就将窗口设置为更小的值通知发送方。如果缓冲区满，就将窗口置为0，发送方收到后就不再发送数据，但是需要定期发送一个**窗口探测数据段**，使接收端把窗口大小告诉发送端。 

![è¿éåå¾çæè¿°](https://img-blog.csdn.net/20180528233153641?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h1emhhbmd6ZQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)



### 滑动窗口

​	TCP流量控制是通过滑动窗口实现的。接收方 和 发送方 都维护一个滑动窗口，用来确认发送和接收的数据分组。

滑动窗口有一个三个指针，后沿、前沿和中间指针。后沿之后的数据都是发送出去并且接收到响应的，不再发送 ； 

后沿到前沿这部分就是要发送的，后沿到中间指针就是正在发送，但是还没有收到响应； 中间指针到前沿这部分就是将发

送但时还没发送的部分。前沿以后的都是要发送的，但是还没轮到他们发送。

​	窗口滑动时机，当发送的报文得到响应时，说明这部分的数据已经不需要了，发送方和接收方就可以向前沿方向滑动窗口。

​	滑动窗口往前沿滑动。前沿到后沿这段距离就是滑动窗口的大小。



















7、拥塞控制 

​	慢启动、拥塞避免、快重传、快恢复。



























