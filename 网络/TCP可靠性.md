

# TCP可靠性

https://mp.weixin.qq.com/s/HqWQ_gzrA1HXvk_PrT5tjA

TCP是面向连接的，进行可靠传输的传输层协议，根据其提供的几点功能，保证了它的可靠性。下面一一介绍。



**超时重传（停止等待协议） → 基础的可靠性**

**滑动窗口 → 流量控制**

**慢开始、快重传、快恢复 → 拥塞控制**





## 一、超时重传（ARQ）

### 1、ARQ

​	TCP发送一个段后，就会启动一个计时器，等到接收端接收到报文后返回的确认响应。如果收不到这个段的确认响应，就重新发送。（没收到就认为刚才发的分组丢失）。确认丢失的计时器时长应该稍微长于分组在网络中来回传输的平均时长。

**重传超时时间**（**RTO**，Retransmission TimeOut）。RTO的值被设置过大过小都会对协议造成不利影响。 

（1）RTO设长了，**重发就慢，没有效率，性能差。** 　　

（2）RTO设短了，**重发的就快，会增加网络拥塞，**导致更多的超时，更多的超时导致更多的重发。 



​	ARQ ： 超时自动重传请求。 即上面的机制。同时，收到重复的分组，虽然接收端会丢弃，但还是必须返回一个确认

​	**普通的ARQ信道利用比较低，因为发一个就需要等待一个响应，所以，衍生出连续ARQ。**



### 2、连续ARQ（连续超时自动重传）

​	**连续ARQ协议可提高信道利用率。** 

​	所谓连续，是指连续发送好几个分组，比如连续发送ABCDE。接收端如果全部接受到，就返回确认收到E的响应，即最后一位的响应。这样发送端就知道A~E已经全部接受。

​	如果中途丢失C，则接受端返回确认响应B，表示C开始的之后没有接收到，需要从C开始重新发送。这就是连续ARQ，连续超时自动重传。





## 二、停止等待协议

- 停止等待协议是为了实现可靠传输的，它的基本原理就是每发完一个分组就停止发送，等待对方确认。在收到确认后再发下一个分组。
- 为了提高传输效率，发送方可以不使用低效率的停止等待协议，而是采用流水线传输。流水线传输就是发送方可连续发送多个分组，不必每发完一个分组就停下来等待对方确认。这样可使信道上一直有数据不间断的在传送。这种传输方式可以明显提高信道利用率。



**理解：**

​	**上面超时自动重传，指的是发送以后确认对方收到，没有手段就重发的 确保发到对方的 手段。**

​	**停止等待协议，也是发一个等一个，也是确保发到对方的手段，有流水线停止等待，和连续ARQ是一样的**



## 三、滑动窗口

​	TCP利用滑动窗口实现流量控制的机制，即 控制报文发送的速率。

​	对于接受端：窗口滑过的部分，就是已经接受并发送确认响应的部分。

​	对于发送端：窗口滑过的部分，就是得到确认响应，发送成功的部分，窗口未滑过的范围，就是还没有成功发送的部分。

​	接收端维护一个缓存池，接收端池满的时候，就会通知发送端不要传了，来不及接收。即控制了传输的速度。接受池空的时候，发送端就可以根据实际提升活动的速度。

​	接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小，从而影响发送方的发送速率。将**窗口字段设置为 0**，则发送方不能发送数据。





## 四、流量控制

​	流量控制是端到端的，接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小，从而影响发送方的发送速率。将窗口字段设置为 0，则发送方不能发送数据。



## 五、拥塞控制

​	拥塞控制是整个网络上的，设计每一台主机、路由，网络的拥塞将导致大面积主机的传输受限。而流量控制是端对端的限制，通过抑制传输速率，确保接收端来得及接受数据。

### 拥塞窗口（cwmd）

为了进行拥塞控制，TCP发送方要维持一个 **拥塞窗口(cwnd)** 的状态变量。拥塞控制窗口的大小取决于网络的拥塞程度，并且动态变化。发送方让自己的发送窗口取为拥塞窗口和接收方的接受窗口中较小的一个。

拥塞控制采用四种算法：**慢开始 、 快重传、快恢复 **和 **拥塞避免** 。

#### 慢开始

​	发送数据时，不确定网络是否拥堵，便从拥塞窗口cwnd的初始值，即1开始发送，作用是探测网络情况，之后逐渐扩大拥塞窗口的容量，即一次发送越来越多的数据。这就是慢开始，直到达到一个合理的平衡点。

#### 拥塞避免

​	拥塞避免是让拥塞窗口cwnd缓慢增大。每经过一个传播轮次就扩大cwnd

#### 快重传和快恢复

​	在TCP/IP中，快速重传和恢复（fast retransmit and recovery，FRR）是一种拥塞控制算法，它能快速恢复丢失的数据包。没有FRR，如果数据包丢失了，TCP将会使用定时器来要求传输暂停。在暂停的这段时间内，没有新的或复制的数据包被发送。有了FRR，如果接收机接收到一个不按顺序的数据段，它会立即给发送机发送一个重复确认。如果发送机接收到三个重复确认，它会假定确认件指出的数据段丢失了，并立即重传这些丢失的数据段。有了FRR，就不会因为重传时要求的暂停被耽误。 　当有单独的数据包丢失时，快速重传和恢复（FRR）能最有效地工作。当有多个数据信息包在某一段很短的时间内丢失时，它则不能很有效地工作。

![img](https://mmbiz.qpic.cn/mmbiz_png/hvUCbRic69sAtXlEkwAAt66dnZ12LoziahdsicftClZUydlEcPVkusOh4jeZSEJeyI1g3eTkpH6xnMbdLPr9eA5aQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



