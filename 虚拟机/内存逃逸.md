# Java逃逸分析

https://mp.weixin.qq.com/s/gtKysPvVoTvtu_cApvZHAg

## 1、导言

- 逃逸分析，主要是判断对象的作用域，从而确定，这个对象是否有必要分配在堆上。

* ```JAVA
  开启逃逸分析：-XX:+DoEscapeAnalysis
  关闭逃逸分析：-XX:-DoEscapeAnalysis
  显示分析结果：-XX:+PrintEscapeAnalysis
  ```

* JDK1.8逃逸分析现在默认开启，不需要配置。

- 逃逸分析算法是基于连通图的数据流分析，是需要耗费CPU资源和一定时间的。



## 2、对象逃逸状态

### 1）参数逃逸（ArgEscape）

```java
即一个对象被作为方法参数传递或者被参数引用，但在调用过程中不会发生全局逃逸，这个状态是通过被调方法的字节码确定的。（通俗理解就是被作为参数传入到一个方法中，但是仅作用在这个方法中。）
```



### 2）全局逃逸（GlobalEscape）

```java
即一个对象的作用范围逃出了当前方法或者当前线程，有如下场景：
- 对象是一个静态对象，已经存在了运行时常量池中
- 对象作为当前方法的返回值
```



### 3）没有逃逸





## 3、逃逸分析带来的优化

​	逃逸分析后，得知一个对象如果没有逃逸，可以有如下优化：

### 1）锁消除

```
多线程中对同步资源的竞争是激烈的，如果分析得知该对象没有逃逸，说明是线程私有，安全的，就无需加锁了，不需要竞争。
```

### 2）标量替换

```
这里先理解标量和聚合量
标量指基本数据类型和引用类型，不可再分解；而聚合量就是对象，可以分解各位多个标量，如一个学生对象，是一个聚合量，是由姓名、性别、身高这些标量组成。聚合量可再分为标量。

那么如果一个对象不会逃逸，就可以不创建它，直接创建可以描述它的标量组合就行，省空间省时。

```

### 3）栈上分配

```
如果对象没有逃逸，就可以根据标量替换，将对象分解为多个标量后，直接在栈上分配，和方法的生命周期相同，随栈帧入栈出栈，降低GC的压力，提高性能。
```











